// FIXME: move me to a dependency instead
syntax = "proto2";

package main;

message KeyPackage {
	required bytes ek = 1;
	required bytes svk = 2;
	required bytes signature = 3;
}

message Member {
	required bytes id = 1;
	required KeyPackage kp = 2;
}

message Roster {
	repeated Member members = 1;
}

message GroupInfo {
	required bytes guid = 1;
	required uint64 epoch = 2;
	required Roster roster = 3;
	required bytes conf_trans_hash = 4;
	required bytes conf_tag = 5;
	required bytes inviter = 6;
	required bytes joiner = 7;
}

message Prop {
	message Remove {
		required bytes id = 1;
	}

	message Update {
		required KeyPackage kp = 1;
	}

	message Add {
		required bytes id = 1;
		required KeyPackage kp = 2;
	}

	oneof variant {
		// option (validate.required) = true;

		Remove remove = 1;
		Update update = 2;
		Add add = 3;
	}
}

message FramedProposal {
	required bytes guid = 1;
	required uint64 epoch = 2;
	required bytes sender = 3;
	required Prop prop = 4;
	required bytes sig = 5;
	required bytes mac = 6;
	required bytes nonce = 7;
}

message CmpdCti {
	required bytes cti = 1;
	required bytes iv = 2;
	required bytes sym_ct = 3;
}

message Commit {
	required KeyPackage kp = 1;
	required CmpdCti cti = 2;
	repeated bytes prop_ids = 3;
}

message FramedCommit {
	required bytes guid = 1;
	required uint64 epoch = 2;
	required bytes sender = 3;
	required Commit commit = 4;
	required bytes sig = 5;
	required bytes conf_tag = 6;
}

enum ContentType {
	App = 1;
	Propsl = 2;
	Commt = 3;
}

// TODO: also send ctds

message Ciphertext {
	required ContentType content_type = 1;
	required bytes content_id = 2;
	required bytes payload = 3;
	required bytes guid = 4;
	required uint64 epoch = 5;
	required uint32 gen = 6;
	required bytes sender = 7;
	required bytes iv = 8;
	required bytes sig = 9;
	required bytes mac = 10;
}